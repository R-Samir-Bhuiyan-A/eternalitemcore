name: EternalItemCore Auto CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# Needed for GHCR pushes and GitHub Releases
permissions:
  contents: write
  packages: write
  pull-requests: write
  id-token: write

jobs:
  build-plugin:
    name: Build Plugin (Maven/Java)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Compile Java Plugin (.jar)
        run: mvn clean package --file pom.xml
      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EternalItemCore-DevBuild
          path: ./target/EternalItemCore-*.jar
          if-no-files-found: error

  release:
    name: Auto Release Plugin
    needs: [build-plugin]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Built Plugin Artifact
        uses: actions/download-artifact@v4
        with:
          name: EternalItemCore-DevBuild
          path: ./artifact-bin
          
      - name: Auto-Generate Release Notes
        id: generate_changelog
        run: |
          # Generate a short hash payload for unique releasing without tags
          SHORT_SHA=$(git rev-parse --short HEAD)
          RELEASE_TAG="v1.4.0-$SHORT_SHA"
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
          # Rename the artifact to match the release tag dynamically
          JAR_FILE=$(find ./artifact-bin -name "EternalItemCore-*.jar" | head -n 1)
          mv "$JAR_FILE" "./artifact-bin/EternalItemCore-$RELEASE_TAG.jar"
          echo "jar_path=./artifact-bin/EternalItemCore-$RELEASE_TAG.jar" >> $GITHUB_OUTPUT
          
          # Get the latest commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "## ðŸš€ EternalItemCore Stable Release (Build $SHORT_SHA)" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ðŸ“ What's Changed" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### Verification Pipeline" >> $GITHUB_OUTPUT
          echo "âœ… **Java Build**: Compiled natively targeting Paper API JDK 21" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### Instructions" >> $GITHUB_OUTPUT
          echo "- **Plugin Installation**: Drop the \`EternalItemCore-$RELEASE_TAG.jar\` file below into your \`plugins/\` folder and configure via the dashboard or config." >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_changelog.outputs.release_tag }}
          name: "EternalItemCore Build ${{ steps.generate_changelog.outputs.release_tag }}"
          body: ${{ steps.generate_changelog.outputs.notes }}
          files: ${{ steps.generate_changelog.outputs.jar_path }}
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: true
