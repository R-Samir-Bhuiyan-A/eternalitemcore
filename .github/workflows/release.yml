name: CI/CD Build and Release

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  build_and_release:
    name: Build & Auto-Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to create a release and upload assets

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Verify and Extract Maven Version
      id: get_version
      run: |
        # Extract the version from pom.xml
        POM_VERSION=$(mvn -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)
        echo "VERSION=$POM_VERSION" >> $GITHUB_ENV
        echo "Extracted version: $POM_VERSION"

    - name: Build Plugin JAR
      run: mvn -B clean package --file pom.xml

    - name: Prepare Versioned Artifact
      id: prepare_artifact
      run: |
        # Create an auto-versioned file name using the run number as a build prefix
        BUILD_PREFIX="b${{ github.run_number }}"
        CLEAN_VERSION=$(echo "${{ env.VERSION }}" | sed 's/-SNAPSHOT//')
        
        VERSIONED_NAME="EternalItemCore-v${CLEAN_VERSION}-${BUILD_PREFIX}.jar"
        TAG_NAME="v${CLEAN_VERSION}-${BUILD_PREFIX}"
        
        # Rename the built jar to our auto-versioned format
        mv target/EternalItemCore-*.jar "target/${VERSIONED_NAME}"
        
        echo "FILE_NAME=${VERSIONED_NAME}" >> $GITHUB_ENV
        echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
        
        echo "Prepared artifact: ${VERSIONED_NAME}"
        echo "Tag Name: ${TAG_NAME}"

    - name: Generate Release Message
      id: generate_release_notes
      run: |
        # Generate a descriptive message for the release
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
        echo "ðŸš€ **Automated Plugin Release** ðŸš€" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "This release was automatically built, verified, and deployed by the GitHub Actions CI/CD pipeline." >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### Version Info" >> $GITHUB_ENV
        echo "- **Plugin Version:** \`${{ env.VERSION }}\`" >> $GITHUB_ENV
        echo "- **Build Prefix:** \`#${{ github.run_number }}\`" >> $GITHUB_ENV
        echo "- **Generated Artifact:** \`${{ env.FILE_NAME }}\`" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### Installation" >> $GITHUB_ENV
        echo "Download \`${{ env.FILE_NAME }}\` and place it in your server's \`plugins/\` folder, then restart or reload your server." >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Auto Publish Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: "Release ${{ env.TAG_NAME }}"
        body: ${{ env.RELEASE_NOTES }}
        draft: false
        prerelease: false
        files: target/${{ env.FILE_NAME }}
